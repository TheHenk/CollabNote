services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    working_dir: /app
    command: ["node","dist/main.js"]
    environment:
      NODE_ENV: production
      PORT: 4000
      SUPABASE_URL: "${SUPABASE_URL}"
      SUPABASE_SERVICE_KEY: "${SUPABASE_SERVICE_KEY}"
      JWT_SECRET: "${JWT_SECRET}"
      JWT_EXPIRES_IN: 1d
    restart: unless-stopped
    # TEMP: publish a debug port so you can test without Caddy
    ports:
      - "4001:4000"
    networks:
      kw8oo4kk80so8080o0g0cgcw: {}
    labels:
      # Caddy (Coolify v4 style) â€“ send domain traffic to container:4000
      - caddy_0=https://backend.henkify.org
      - caddy_0.reverse_proxy={{upstreams 4000}}
      - caddy_0.encode=zstd gzip
      - caddy_0.header=-Server
      - caddy_ingress_network=kw8oo4kk80so8080o0g0cgcw

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    working_dir: /app
    environment:
      VITE_API_URL: "https://backend.henkify.org"
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      kw8oo4kk80so8080o0g0cgcw: {}
    labels:
      - caddy_0=https://collabnotes.henkify.org
      - caddy_0.reverse_proxy={{upstreams}}
      - caddy_0.encode=zstd gzip
      - caddy_0.header=-Server
      - caddy_ingress_network=kw8oo4kk80so8080o0g0cgcw

networks:
  kw8oo4kk80so8080o0g0cgcw:
    name: kw8oo4kk80so8080o0g0cgcw
    external: true
